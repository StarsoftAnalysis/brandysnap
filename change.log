Changelog for brandysnap
========================

0.2.20	28/11/14
* Added --ldmin option
* Fixed bugs:
  - time-out errors not setting flags correctly -- fix use of 'last SOURCE'

0.2.19	9/9/2014
* Incorporated Cygwin compatibility code
* Fixed bugs:
  - deal with destination file system becoming read-only

0.2.18	23/12/2013
* Added --filter option -- see documentation.
* Reworked all rsync include/exclude/filter options to keep them in
  the same order as specified.  Any such option in a context overrides
  all of them in the previous context.
* Fixed bugs:
  - emailSend had the test backwards!
  - don't delete a failed snapshot if we've restarted
  - mark snapshot as restartable after a timeout (some data may have been
    copied)

0.2.17	6/11/2013
* Added --latest-copy option -- see documentation.
* include-from and exclude-from files are now checked for readability.
  They can also be remote, which is sometimes convenient.
* Fixed bugs:
  - tweaked choice of snapshots to delete (in getMatchingSnapshots)
  - in getDeleteList, don't reconsider snapshots deleted for a previous spec.
  - process a destination even if none of its sources are readable 
    (so that status still works etc.)
  - don't attempt to create 'latest' snapshot on a dry run.

0.2.16	28/10/2013
* Added --hostname option -- see documentation.
* Added --latest option -- see documentation.
* Added --timeout-retries option -- see documentation.
* Removed 'experimental' Perl features 'given', 'when', and smart-match.
* Fixed bugs:
  - bug in status() when oldest spec was unfinished
  - include module in host directory name when source is a daemon
  - more general error match for 'timed out' or 'timeout'
  - bug in fmtRange() -- use 'approx' mode for months and years
  - count in status listing included unfinished snapshots
  - cope with changed --stats output in rsync 3.1.0
  - --version now displays the version! (thanks to Nicholas Wastell)
  - corrections to the documentation (thanks to Nicholas Wastell)

0.2.15	30/05/2013
* Replace 'bwlimit-in' and 'bwlimit-out' options with single 'bwlimit' --
  possible now that options can be specified per source or destination.
* Added period covered by each spec to the status listing at level 3 or
  greater.
* Bug fixes:
  - use full range when visualising partial periods
  - set end of current period to proper end, not now+1
  - better fmtRange() that copes with DST changes
  - better bytes() that deals with edge cases
  - better printit() and logit()

0.2.14  01/03/2013
* Add 'visualisation' of snapshots (at verbosity 3) when deleting them.
* Bug fixes:
  - was deleting the new snapshot twice when not required.

0.2.13  22/02/2013
* Empty (or apparently empty) sources are now treated as failures
  (including sources containing only empty directories).
* Don't count 'small' snapshots as good ones when setting up --link-dest
  options (where 'small' means less than (currently) 30% of the average.
* Rewrite status() to calculate totals and averages properly.
* Changed order of testing for errors in runRsync.
* --include-from and --exclude-from files are now tested and ignored if they
  don't exist; they can also now be remote, so that they can be kept on the
  same machine as the source that they apply to.
* Better messages when deleting snapshots.
* Minor bugs:
  - mark destination as successful if it wasn't needed.
  - tidied error messages for command line option errors.

0.2.12
* Check for and delete any completely empty snapshots
* Change the way existing snapshots are counted: for example if the spec calls
  for 7 snapshots in a week, and there are 3 last week and 4 the week before,
  then that now meets the requirement; previously the algorithm would look
  for a single week with 7 snapshots.
* Bug fixes:
  - display summary correctly when there are 'old' but undeleted snapshots.
  - deal with zero-size sources as failures

0.2.11
* Allow use of 'notes' on snapshot names to prevent deletion,
  and tweak the code to make noted snapshots more likely to be kept.
* Deal with (very unlikely) duplicate snapshot folders.
* Reworked error/warning/note reporting.
* Better trapping of time-out errors.
* Better handling of interruptions.
* More information in warning messages when sources and destinations are
  unavailable

0.2.10
* Display more complete results, including elapsed times.
* Send emails if not successful -- see various --email-xxx options.
* Bug fixes:
  - displaySummary -- don't assume that destination start and stop
    times exist.
  - fixed two bugs that only show up in Perl 5.10.1: use of
    'keys $hashRef' instead of 'keys %$hashRef'

0.2.9
* Added option --rsync-xopts.
* Print the getDeleteList summary only when debugging.
* Display the 'padded' specs in the options summary and status listing.
* Simplified the output from displayCSpecs.
* Moved the test suite to a separate file.
* Print timings for each source, destination, and whole run.
* Bugs fixed:
  - use $timesofar properly in parseSpecs().
  - new version of fmtHours() that works.

0.2.8
* Better 'status' listing, including the size and number of files transferred
  by rsync, gleaned from rsync's --stats option 
* '--verbose 0' is now completely silent.

0.2.7
* Changes:
  - Remove 'stacktrace' option: just print a stacktrace when debugging.
  - Better locking: 
    + lock the destination directory by creating a 'lock directory' within it;
      if lock directories from previous runs exist, and the corresponding pid
      is not still running, the lock is removed.
    + lock the logfile instead of having to specify a separate lockfile.
      (The --lockfile option is now obsolete and ignored.)
* Bug fixes:
  - Create the destination directory as soon as the timestamp is known
    to reduce the risk of a race condition and simplify code in runRsync().

0.2.6
* Bug fixes:
  - Check for lock before writing anything to the log file.
  - Clarify use of terms 'partial', 'incomplete', and 'unfinished'.  
    Now, the specific meanings are:
     'incomplete' -- a period with too few snapshots.
     'partial'    -- part of a period, e.g. the part of a week used to
                     pad out a full month.
     'unfinished' -- a snapshot that was not created fully for some reason.
  - Fix min-interval code to check date of S[0], not S[1].
  - Tidy up unused $PartialSuffix.

0.2.5	3/11/12
* Streamlined compileCSpecs to ignore old periods before any snapshots.
* Improved displayCSpecs.
* Bug fixes:
  - Use UNLIMITED instead of -1 for freqmax to indicate 'keep all'.

0.2.4	25/10/12
* More information in status report re periods covered by each spec.
* Automatically restart if the previous snapshot failed and was less than
  min-interval minutes ago.
* Bug fixes:
  - Corrected logic re deleteNew.
  - Tweaked snapshot timing to prevent creep.
  - Ignore <x>best options in nocalendar mode.

0.2.3	11/10/12
* Bug fixes:
  - Reset partial flag when restarting
  - If the timings of snapshots are slightly out, a snapshot may appear to be in 
    the wrong period, which will affect deletions.  
    For example, when doing one snapshot a day with calendar mode turned off, if 
    yesterday's snapshot was at 11:40:03, and today's is at 11:40:01, 
    then yesterday's will be considered as part of today, 
    because it is less than 24 hours ago, so it will be deleted.  
    brandysnap now checks for this before it happens, and delays the new
    snapshot by a few seconds to avoid the problem.
  - Better message when deleting snapshots from 'old' cspec.
  - Fixed processing of --no prefix on options in configuration file.
  - Corrected validation of context options.
  - Better formatting of displayed options (in the same style as the
    configuration file).
  - Better command line validation.
  - Changed validation of boolean options -- now only accept '--no' prefix,
    not yes/true/on/1 or no/false/off/0 values.

0.2.2	8/10/12
* Improved logic for choosing which snapshots to delete when dealing
  'partial' periods, e.g. between days and weeks in calendar mode

0.2.1	5/10/12
* Bug fixes:
  - use exclude/include options /after/ context override.
  - don't try to check for writable destination with --dry-run.
  - allow for blank period in 'old' cSpec.
  - set rsync's timeout=60 option to avoid hanging when connection is lost
    and trap time-outs appropriately.
  - don't give message about 'no-delete' if interrupted.
  - when --no-snapshot specified, don't show current one in status or
    metadata.
  - fix logic in processDestinations re --no-snapshot and tidy output.
  - skip partial backups when considering min-interval.
* Allow abbreviated options in configuration file.
* Print configuration file name at top of output.
* Better control of debugging output.
* Prettier line spacing in output.
* Prettier formatting of snapshot sizes.
* --restart now implies --min-interval=0
* Changed deletion logic so that incomplete snapshots are kept unless
  there are enough complete ones for the period.

0.2.0	20/9/12
* added sections (aka contexts) to configuration
  allowing more targeted use of 'exclude' etc.
  - many related changes to option validation
* checked date handling for daylight saving and leap years.

0.1.20	01/6/12
* add 'min-interval' option

0.1.19	14/4/12
* better/simpler interrupt handling
* add summary of successes and failures
* bugfix: recalculate size of restarted snapshots

0.1.18	6/2/12
* replace '-x' suffix on partial snapshots with metadata in a status file
  - that makes a lot of things easier, but we now rely on the metadata file
    to know which backups are partial.
* simplified the status listing
* correctly deal with multiple remote sources
* always add a host-name subdirectory, even for local sources (because it's
  more consistent, and doesn't lead to problems if a jobs is changed
  from push to pull.
* corrections to systemCall to prevent segfault with Perl 5.14.2
* code tidying, including the test cases

0.1.17	30/1/12
* fix bug in clearSuffix(), so --restart works again
* use GetOpt::Long (and some extra code) instead of Config::General for reading 
  the configuration file

0.1.16	16/1/12
* fix error handling when no remote sources are readable
* fix handling of interrupts and --allow-restart option
* Improved error checking in deleteOrRenameSnapshot(); and interaction with --allow-restart option.
* Restructured: %S now global, with more information in it
  - lots of changes as a result
 
0.1.15	6/11/11
* fixed bug when jumping back one hour at same time as daylight savings ends

0.1.14	5/11/11
* allow range (minimum - maximum) on number of snapshots in a period, aka the 'frequency'
* fixes to option checking
* fixes for remote destinations
* fixes re handling incomplete snapshots
 
0.1.13	24/10/11 
* adjustments to signal handling 
* multiple link-dests via --ldcount option 
* rename incomplete backups, with new options --all-failed, --some-failed,
  and associated changes to getDeleteList, getMatchingSnapshots etc.

0.1.12 
* added 'allow-restart' option 
* better exit code handling 
* simplified return code checking in runRsync 
* fix bugs in getExpirableSnapshots 
* other debugging 
 
0.1.11 
* add signal handling 
 
0.1.10 
* treat rsync error 24 as minor (files vanished) 

0.1.9 
* corrections re getDeleteList if rsync failed 
* add 'restart' option 

0.1.8	9/8/11
* oops! There are 12 months in a year, not 52. 
  (Only affected specs that auto-padded months to fill a year)

0.1.7	25/01/11
* new version of snapshotInfoRemote -- hopefully it's quick enough now.

0.1.6
* restructured run() so that compileSpecs only has to be run once,
  and the case where a new snapshot would be immediately deleted can be avoided.
* improvements to fmtRange

0.1.4   04/07/11  Minor bug fixes

0.1.3   01/07/11
 * no snapshot info for remote destination -- too slow (for now).
 * better validation of bandwith limit options.
 * rsync-options -- don't include the essential ones (--relative)
   in the option, and put the user's ones first.
 * strip unnecessary quotes and spaces from string options.
 * improvements to spec alignment -- use partial periods
   if they have enough snapshots.
 * re-write compileSpecs to make it prettier and right
   with corresponding changes to findGoodPeriods etc.

0.1.1	19/06/11  Minor bug fixes

0.1.0	18/06/11  First public release
